// Code generated by testgen. DO NOT EDIT.
package ast

import (
	"fmt"
	"testing"
	"strings"

	"github.com/stretchr/testify/require"
)
			
func Test10PromptAst(t *testing.T) {
	input := `
@printf("What is your name?\n")
@prompt(10, (name: @str){
    @printf("Hello, %s!\n", name)
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "What is your name?\n"
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@printf"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 10
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "Hello, %s!\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "name"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "name",
                         "_type": "Type",
                         "value": "@str"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@prompt"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test11Prompt2Ast(t *testing.T) {
	input := `
@printf("What is your name?\n")
callback1: (title: @str, name: @str){
    @printf("What is your age?\n")
    @prompt(3, (age: @str){
        @printf("Hello %s %s age %s!\n", title, name, age)
    })
}
@prompt(10, callback1("Dear"))

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "What is your name?\n"
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@printf"
         }
     },
     {
         "_name": "callback1",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "What is your age?\n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 3
                     },
                     {
                         "_type": "Function",
                         "inner": [
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "StringLiteral",
                                         "value": "Hello %s %s age %s!\n"
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "title"
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "name"
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "age"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "isbuiltin": true,
                                     "of": "@printf"
                                 }
                             }
                         ],
                         "params": [
                             {
                                 "_name": "age",
                                 "_type": "Type",
                                 "value": "@str"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@prompt"
                 }
             }
         ],
         "params": [
             {
                 "_name": "title",
                 "_type": "Type",
                 "value": "@str"
             },
             {
                 "_name": "name",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 10
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "Dear"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "callback1"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@prompt"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test11Prompt3Ast(t *testing.T) {
	input := `
@printf("What is your name?\n")
@prompt(50, (name: @str){
    @printf("What is your age?\n")
    @prompt(3, (age: @str){
        @printf("Hello, %s %s!\n", name, age)
    })
})
`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "What is your name?\n"
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@printf"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 50
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "What is your age?\n"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     },
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "IntLiteral",
                                 "value": 3
                             },
                             {
                                 "_type": "Function",
                                 "inner": [
                                     {
                                         "_type": "Apply",
                                         "arguments": [
                                             {
                                                 "_type": "StringLiteral",
                                                 "value": "Hello, %s %s!\n"
                                             },
                                             {
                                                 "_type": "Label",
                                                 "of": "name"
                                             },
                                             {
                                                 "_type": "Label",
                                                 "of": "age"
                                             }
                                         ],
                                         "callee": {
                                             "_type": "Label",
                                             "isbuiltin": true,
                                             "of": "@printf"
                                         }
                                     }
                                 ],
                                 "params": [
                                     {
                                         "_name": "age",
                                         "_type": "Type",
                                         "value": "@str"
                                     }
                                 ]
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@prompt"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "name",
                         "_type": "Type",
                         "value": "@str"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@prompt"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test12MathAddAst(t *testing.T) {
	input := `
@add(3, 3, (x: @int){
    @printf("x: %d\n", x)   
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 3
             },
             {
                 "_type": "IntLiteral",
                 "value": 3
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "x: %d\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "x"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "x",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@add"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test12MathMulAst(t *testing.T) {
	input := `
mymul: @mul(3, 3)
mymul((x: @int){
    @printf("x: %d\n", x)   
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "mymul",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 3
             },
             {
                 "_type": "IntLiteral",
                 "value": 3
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@mul"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "x: %d\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "x"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "x",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "mymul"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test13FuncIdAst(t *testing.T) {
	input := `
puts: (s: @str){
    @unsafe.libc.puts(s, (code:@int){})
}
puts("hello world!")

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "puts",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "s"
                     },
                     {
                         "_type": "Function",
                         "params": [
                             {
                                 "_name": "code",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@unsafe.libc.puts"
                 }
             }
         ],
         "params": [
             {
                 "_name": "s",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "hello world!"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "puts"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test14AnonCurryAst(t *testing.T) {
	input := `
foo: (msg: @str){
    @unsafe.libc.puts(msg, (code:@int){})
}("hi")
foo()

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "foo",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "hi"
             }
         ],
         "callee": {
             "_type": "Function",
             "inner": [
                 {
                     "_type": "Apply",
                     "arguments": [
                         {
                             "_type": "Label",
                             "of": "msg"
                         },
                         {
                             "_type": "Function",
                             "params": [
                                 {
                                     "_name": "code",
                                     "_type": "Type",
                                     "value": "@int"
                                 }
                             ]
                         }
                     ],
                     "callee": {
                         "_type": "Label",
                         "isbuiltin": true,
                         "of": "@unsafe.libc.puts"
                     }
                 }
             ],
             "params": [
                 {
                     "_name": "msg",
                     "_type": "Type",
                     "value": "@str"
                 }
             ]
         }
     },
     {
         "_type": "Apply",
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test15AnonCallAst(t *testing.T) {
	input := `
(msg: @str){
    @unsafe.libc.puts(msg, (code:@int){})
}("hi")

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "hi"
             }
         ],
         "callee": {
             "_type": "Function",
             "inner": [
                 {
                     "_type": "Apply",
                     "arguments": [
                         {
                             "_type": "Label",
                             "of": "msg"
                         },
                         {
                             "_type": "Function",
                             "params": [
                                 {
                                     "_name": "code",
                                     "_type": "Type",
                                     "value": "@int"
                                 }
                             ]
                         }
                     ],
                     "callee": {
                         "_type": "Label",
                         "isbuiltin": true,
                         "of": "@unsafe.libc.puts"
                     }
                 }
             ],
             "params": [
                 {
                     "_name": "msg",
                     "_type": "Type",
                     "value": "@str"
                 }
             ]
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test16ComptimeParamAst(t *testing.T) {
	input := `
foo: (s: @str!) {
    @unsafe.libc.puts(s, (code:@int){})
}
foo("hi")

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "s"
                     },
                     {
                         "_type": "Function",
                         "params": [
                             {
                                 "_name": "code",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@unsafe.libc.puts"
                 }
             }
         ],
         "params": [
             {
                 "_name": "s",
                 "_type": "Type",
                 "comptime": true,
                 "value": "@str"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "hi"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test17AtoiAst(t *testing.T) {
	input := `
@unsafe.libc.atoi("123", (x: @int){
    @printf("result: %d\n", x)
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "123"
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "result: %d\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "x"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "x",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@unsafe.libc.atoi"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test18GtAst(t *testing.T) {
	input := `
@igt(2, 3, (){
    @printf("More\n")
}, (){
    @printf("Less\n")
})
`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 2
             },
             {
                 "_type": "IntLiteral",
                 "value": 3
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "More\n"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ]
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "Less\n"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@igt"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test19IfAst(t *testing.T) {
	input := `
if: (cond: ((),()), ok:()){
    cond(ok, {})
}
if(@igt(4, 3), {
    @printf("More\n")
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "if",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "ok"
                     },
                     {
                         "_type": "Function"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cond"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cond",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type"
                     },
                     {
                         "_type": "Type"
                     }
                 ]
             },
             {
                 "_name": "ok",
                 "_type": "Type"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 4
                     },
                     {
                         "_type": "IntLiteral",
                         "value": 3
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@igt"
                 }
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "More\n"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "if"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test1PrintAst(t *testing.T) {
	input := `
@unsafe.libc.puts("hello world!", (code:@int){})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "hello world!"
             },
             {
                 "_type": "Function",
                 "params": [
                     {
                         "_name": "code",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@unsafe.libc.puts"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test20AnonImmediateCallAst(t *testing.T) {
	input := `
(){
    @printf("Hi\n")
}
`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "Hi\n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ]
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test21AnonImmediateCallAst(t *testing.T) {
	input := `
{
    @printf("Hi\n")
}
`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "Hi\n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ]
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test22ClosureIntAst(t *testing.T) {
	input := `
baz: (x: @int, y: @int) {
    ok: @add(3, x)
    ok((res: @int){
        @printf("%d %d\n", res, y)
    })
}
baz(5, 1)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "baz",
         "_type": "Function",
         "inner": [
             {
                 "_name": "ok",
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 3
                     },
                     {
                         "_type": "Label",
                         "of": "x"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@add"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Function",
                         "inner": [
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "StringLiteral",
                                         "value": "%d %d\n"
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "res"
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "y"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "isbuiltin": true,
                                     "of": "@printf"
                                 }
                             }
                         ],
                         "params": [
                             {
                                 "_name": "res",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             }
         ],
         "params": [
             {
                 "_name": "x",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "y",
                 "_type": "Type",
                 "value": "@int"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 5
             },
             {
                 "_type": "IntLiteral",
                 "value": 1
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "baz"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test23ClosureIntAst(t *testing.T) {
	input := `
foo: (x:@int){
	ok: (s: @int){
		@unsafe.libc.printf("num: %d\n", s, (code:@int){})
	}
	ok(x)
	ok(x)
}
foo(5)
`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_name": "ok",
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "num: %d\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "s"
                             },
                             {
                                 "_type": "Function",
                                 "params": [
                                     {
                                         "_name": "code",
                                         "_type": "Type",
                                         "value": "@int"
                                     }
                                 ]
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@unsafe.libc.printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "s",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "x"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "x"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             }
         ],
         "params": [
             {
                 "_name": "x",
                 "_type": "Type",
                 "value": "@int"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 5
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test24RecursivePrintAst(t *testing.T) {
	input := `
printnums: (n: @int) {
    @printf("%d\n", n)
    @add(1, n, (n: @int){
        printnums(n)
    })
}
printnums(0)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "printnums",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "%d\n"
                     },
                     {
                         "_type": "Label",
                         "of": "n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 1
                     },
                     {
                         "_type": "Label",
                         "of": "n"
                     },
                     {
                         "_type": "Function",
                         "inner": [
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "Label",
                                         "of": "n"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "of": "printnums"
                                 }
                             }
                         ],
                         "params": [
                             {
                                 "_name": "n",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@add"
                 }
             }
         ],
         "params": [
             {
                 "_name": "n",
                 "_type": "Type",
                 "value": "@int"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 0
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "printnums"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test25RecursivePrintLimitAst(t *testing.T) {
	input := `
printnums: (n: @int) {
    @printf("%d\n", n)
    @ieq(n, 1000, {}, {
        @add(1, n, printnums)
    })
}
printnums(0)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "printnums",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "%d\n"
                     },
                     {
                         "_type": "Label",
                         "of": "n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "n"
                     },
                     {
                         "_type": "IntLiteral",
                         "value": 1000
                     },
                     {
                         "_type": "Function"
                     },
                     {
                         "_type": "Function",
                         "inner": [
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "IntLiteral",
                                         "value": 1
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "n"
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "printnums"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "isbuiltin": true,
                                     "of": "@add"
                                 }
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@ieq"
                 }
             }
         ],
         "params": [
             {
                 "_name": "n",
                 "_type": "Type",
                 "value": "@int"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 0
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "printnums"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test26LinkedListAst(t *testing.T) {
	input := `
list: ((@int, list)) // recursive type 
nil: (cb:(@int, list)){}
cons: (h:@int, t:list, cb:(@int, list)){
    cb(h, t)
}
iterate: (head:@int, tail: list){
    @printf("%d\n", head)
    tail(iterate) // if tail is nil, it does nothing 
}
mylist: cons(1, cons(2, cons(3, cons(4, nil)))) // TODO: when the target type is ptr, then the arg type can also be a ptr?
mylist(iterate)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "list",
         "_type": "Type",
         "values": [
             {
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "nil",
         "_type": "Function",
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "cons",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "h"
                     },
                     {
                         "_type": "Label",
                         "of": "t"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "h",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "t",
                 "_type": "Type",
                 "value": "list"
             },
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "iterate",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "%d\n"
                     },
                     {
                         "_type": "Label",
                         "of": "head"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "iterate"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "tail"
                 }
             }
         ],
         "params": [
             {
                 "_name": "head",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "tail",
                 "_type": "Type",
                 "value": "list"
             }
         ]
     },
     {
         "_name": "mylist",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 1
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 2
                     },
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "IntLiteral",
                                 "value": 3
                             },
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "IntLiteral",
                                         "value": 4
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "nil"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "of": "cons"
                                 }
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "cons"
                         }
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cons"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "cons"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "iterate"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "mylist"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test27LinkedListEndAst(t *testing.T) {
	input := `
list: ((@int, list), ()) // recursive type 
nil: (cb:(@int, list), end:()){end()}
cons: (h:@int, t:list, cb:(@int, list)){
    cb(h, t)
}
iterate: (head:@int, tail: list){
    @printf("%d\n", head)
    tail(iterate, (){
        @printf("%s\n", "end")
    }) 
}
mylist: cons(1, cons(2, cons(3, cons(4, nil))))
mylist(iterate)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "list",
         "_type": "Type",
         "values": [
             {
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             },
             {
                 "_type": "Type"
             }
         ]
     },
     {
         "_name": "nil",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "callee": {
                     "_type": "Label",
                     "of": "end"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             },
             {
                 "_name": "end",
                 "_type": "Type"
             }
         ]
     },
     {
         "_name": "cons",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "h"
                     },
                     {
                         "_type": "Label",
                         "of": "t"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "h",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "t",
                 "_type": "Type",
                 "value": "list"
             },
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "iterate",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "%d\n"
                     },
                     {
                         "_type": "Label",
                         "of": "head"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "iterate"
                     },
                     {
                         "_type": "Function",
                         "inner": [
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "StringLiteral",
                                         "value": "%s\n"
                                     },
                                     {
                                         "_type": "StringLiteral",
                                         "value": "end"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "isbuiltin": true,
                                     "of": "@printf"
                                 }
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "tail"
                 }
             }
         ],
         "params": [
             {
                 "_name": "head",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "tail",
                 "_type": "Type",
                 "value": "list"
             }
         ]
     },
     {
         "_name": "mylist",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 1
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 2
                     },
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "IntLiteral",
                                 "value": 3
                             },
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "IntLiteral",
                                         "value": 4
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "nil"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "of": "cons"
                                 }
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "cons"
                         }
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cons"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "cons"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "iterate"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "mylist"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test28LinkedListEachAst(t *testing.T) {
	input := `
list: ((@int, list)) // recursive type 
nil: (cb:(@int, list)){}
cons: (h:@int, t:list, cb:(@int, list)){
    cb(h, t)
}
iterate: (ok: (@int), head:@int, tail: list){
    ok(head)
    tail(iterate(ok)) // if tail is nil, it does nothing 
}
each: (list: list, ok: (@int)){
    list(iterate(ok))
}
mylist: cons(1, cons(2, cons(3, cons(4, nil))))
each(mylist, (n: @int){
    @printf("%d\n", n)
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "list",
         "_type": "Type",
         "values": [
             {
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "nil",
         "_type": "Function",
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "cons",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "h"
                     },
                     {
                         "_type": "Label",
                         "of": "t"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "h",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "t",
                 "_type": "Type",
                 "value": "list"
             },
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "iterate",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "head"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "Label",
                                 "of": "ok"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "iterate"
                         }
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "tail"
                 }
             }
         ],
         "params": [
             {
                 "_name": "ok",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             },
             {
                 "_name": "head",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "tail",
                 "_type": "Type",
                 "value": "list"
             }
         ]
     },
     {
         "_name": "each",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "Label",
                                 "of": "ok"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "iterate"
                         }
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "list"
                 }
             }
         ],
         "params": [
             {
                 "_name": "list",
                 "_type": "Type",
                 "value": "list"
             },
             {
                 "_name": "ok",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "mylist",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 1
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 2
                     },
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "IntLiteral",
                                 "value": 3
                             },
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "IntLiteral",
                                         "value": 4
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "nil"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "of": "cons"
                                 }
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "cons"
                         }
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cons"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "cons"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "mylist"
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "%d\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "n"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "n",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "each"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test29LinkedListEachEndAst(t *testing.T) {
	input := `
list: ((@int, list), ()) // recursive type 
nil: (cb:(@int, list), end:()){end()}
cons: (h:@int, t:list, cb:(@int, list)){
    cb(h, t)
}
iterate: (ok: (@int), end: (), head:@int, tail: list){
    ok(head)
    tail(iterate(ok, end), end) // if tail is nil, it does nothing 
}
each: (list: list, ok: (@int), end: ()){
    list(iterate(ok, end), end)
}

// ^ above is a library

mylist: cons(1, cons(2, cons(3, cons(4, nil))))
each(mylist, (n: @int){
    @printf("%d\n", n)
}, {
    @printf("%s\n", "end")
})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "list",
         "_type": "Type",
         "values": [
             {
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             },
             {
                 "_type": "Type"
             }
         ]
     },
     {
         "_name": "nil",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "callee": {
                     "_type": "Label",
                     "of": "end"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             },
             {
                 "_name": "end",
                 "_type": "Type"
             }
         ]
     },
     {
         "_name": "cons",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "h"
                     },
                     {
                         "_type": "Label",
                         "of": "t"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "h",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "t",
                 "_type": "Type",
                 "value": "list"
             },
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     },
                     {
                         "_type": "Type",
                         "value": "list"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "iterate",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "head"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "Label",
                                 "of": "ok"
                             },
                             {
                                 "_type": "Label",
                                 "of": "end"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "iterate"
                         }
                     },
                     {
                         "_type": "Label",
                         "of": "end"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "tail"
                 }
             }
         ],
         "params": [
             {
                 "_name": "ok",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             },
             {
                 "_name": "end",
                 "_type": "Type"
             },
             {
                 "_name": "head",
                 "_type": "Type",
                 "value": "@int"
             },
             {
                 "_name": "tail",
                 "_type": "Type",
                 "value": "list"
             }
         ]
     },
     {
         "_name": "each",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "Label",
                                 "of": "ok"
                             },
                             {
                                 "_type": "Label",
                                 "of": "end"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "iterate"
                         }
                     },
                     {
                         "_type": "Label",
                         "of": "end"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "list"
                 }
             }
         ],
         "params": [
             {
                 "_name": "list",
                 "_type": "Type",
                 "value": "list"
             },
             {
                 "_name": "ok",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             },
             {
                 "_name": "end",
                 "_type": "Type"
             }
         ]
     },
     {
         "_name": "mylist",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "IntLiteral",
                 "value": 1
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 2
                     },
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "IntLiteral",
                                 "value": 3
                             },
                             {
                                 "_type": "Apply",
                                 "arguments": [
                                     {
                                         "_type": "IntLiteral",
                                         "value": 4
                                     },
                                     {
                                         "_type": "Label",
                                         "of": "nil"
                                     }
                                 ],
                                 "callee": {
                                     "_type": "Label",
                                     "of": "cons"
                                 }
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "of": "cons"
                         }
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cons"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "cons"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "mylist"
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "%d\n"
                             },
                             {
                                 "_type": "Label",
                                 "of": "n"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "n",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             },
             {
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "StringLiteral",
                                 "value": "%s\n"
                             },
                             {
                                 "_type": "StringLiteral",
                                 "value": "end"
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@printf"
                         }
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "each"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test2IntConstAst(t *testing.T) {
	input := `
x: 12
@printf("%d", x)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "x",
         "_type": "IntLiteral",
         "value": 12
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "%d"
             },
             {
                 "_type": "Label",
                 "of": "x"
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@printf"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test2StrConstAst(t *testing.T) {
	input := `
msg: "hello world"
@unsafe.libc.puts(msg, (code:@int){})

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "msg",
         "_type": "StringLiteral",
         "value": "hello world"
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "msg"
             },
             {
                 "_type": "Function",
                 "params": [
                     {
                         "_name": "code",
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ],
         "callee": {
             "_type": "Label",
             "isbuiltin": true,
             "of": "@unsafe.libc.puts"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test3FuncAst(t *testing.T) {
	input := `
msg: "hello world"
foo: (){
    @unsafe.libc.puts(msg, (code:@int){})
}
foo()

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "msg",
         "_type": "StringLiteral",
         "value": "hello world"
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "msg"
                     },
                     {
                         "_type": "Function",
                         "params": [
                             {
                                 "_name": "code",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@unsafe.libc.puts"
                 }
             }
         ]
     },
     {
         "_type": "Apply",
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test3Func2Ast(t *testing.T) {
	input := `
msg: "hello world"
foo: (s:@str){
    @unsafe.libc.puts(s, (code:@int){})
}
foo(msg)
`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "msg",
         "_type": "StringLiteral",
         "value": "hello world"
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "s"
                     },
                     {
                         "_type": "Function",
                         "params": [
                             {
                                 "_name": "code",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@unsafe.libc.puts"
                 }
             }
         ],
         "params": [
             {
                 "_name": "s",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "msg"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test4FuncAst(t *testing.T) {
	input := `
msg: "hello world"
foo: {
    @unsafe.libc.puts(msg, (code:@int){})
}
foo

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "msg",
         "_type": "StringLiteral",
         "value": "hello world"
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "msg"
                     },
                     {
                         "_type": "Function",
                         "params": [
                             {
                                 "_name": "code",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@unsafe.libc.puts"
                 }
             }
         ]
     },
     {
         "_type": "Apply",
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test5FuncStdAst(t *testing.T) {
	input := `
foo: (x: @str){
	ok: (s: @str){
		@unsafe.libc.puts(s, (code:@int){})
	}
	ok(x)
	ok(x)
}
foo("hello world")

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_name": "ok",
                 "_type": "Function",
                 "inner": [
                     {
                         "_type": "Apply",
                         "arguments": [
                             {
                                 "_type": "Label",
                                 "of": "s"
                             },
                             {
                                 "_type": "Function",
                                 "params": [
                                     {
                                         "_name": "code",
                                         "_type": "Type",
                                         "value": "@int"
                                     }
                                 ]
                             }
                         ],
                         "callee": {
                             "_type": "Label",
                             "isbuiltin": true,
                             "of": "@unsafe.libc.puts"
                         }
                     }
                 ],
                 "params": [
                     {
                         "_name": "s",
                         "_type": "Type",
                         "value": "@str"
                     }
                 ]
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "x"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             },
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "x"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "ok"
                 }
             }
         ],
         "params": [
             {
                 "_name": "x",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "hello world"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test6CallbackAst(t *testing.T) {
	input := `
msg: "hello world"
foo: (input: @str){
    @unsafe.libc.puts(input, (code:@int){})
}
bar: (cb:(@str)) {
    cb(msg)
}
bar(foo)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "msg",
         "_type": "StringLiteral",
         "value": "hello world"
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "input"
                     },
                     {
                         "_type": "Function",
                         "params": [
                             {
                                 "_name": "code",
                                 "_type": "Type",
                                 "value": "@int"
                             }
                         ]
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@unsafe.libc.puts"
                 }
             }
         ],
         "params": [
             {
                 "_name": "input",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_name": "bar",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "Label",
                         "of": "msg"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@str"
                     }
                 ]
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "foo"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "bar"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test7ApplyAst(t *testing.T) {
	input := `
msg: "hello world"
foo: (input: @str, n: @int){
    @printf("%s x %ld", input, n)
}
bar: (cb:(@int)) {
    cb(42)
}
qux: foo(msg)
bar(qux)

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "msg",
         "_type": "StringLiteral",
         "value": "hello world"
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "%s x %ld"
                     },
                     {
                         "_type": "Label",
                         "of": "input"
                     },
                     {
                         "_type": "Label",
                         "of": "n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ],
         "params": [
             {
                 "_name": "input",
                 "_type": "Type",
                 "value": "@str"
             },
             {
                 "_name": "n",
                 "_type": "Type",
                 "value": "@int"
             }
         ]
     },
     {
         "_name": "bar",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "IntLiteral",
                         "value": 42
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@int"
                     }
                 ]
             }
         ]
     },
     {
         "_name": "qux",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "msg"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Label",
                 "of": "qux"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "bar"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test8AppliedCallbackAst(t *testing.T) {
	input := `
bar: (m1:@str, m2:@str) {
    @printf("msg1: %s, msg2: %s\n", m1, m2)
}
foo: (cb:(@str)){
    cb("bye")
}
foo(bar("hi"))

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "bar",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "msg1: %s, msg2: %s\n"
                     },
                     {
                         "_type": "Label",
                         "of": "m1"
                     },
                     {
                         "_type": "Label",
                         "of": "m2"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ],
         "params": [
             {
                 "_name": "m1",
                 "_type": "Type",
                 "value": "@str"
             },
             {
                 "_name": "m2",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "bye"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@str"
                     }
                 ]
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "hi"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "bar"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test8CurryAst(t *testing.T) {
	input := `
foo: (n:@str, s:@str){
	@printf("The winning number for %s is %s\n", s, n)
}
bar: foo("42")
baz: foo("43", "Bob")
bar("Alice")
baz()

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "The winning number for %s is %s\n"
                     },
                     {
                         "_type": "Label",
                         "of": "s"
                     },
                     {
                         "_type": "Label",
                         "of": "n"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ],
         "params": [
             {
                 "_name": "n",
                 "_type": "Type",
                 "value": "@str"
             },
             {
                 "_name": "s",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_name": "bar",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "42"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     },
     {
         "_name": "baz",
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "43"
             },
             {
                 "_type": "StringLiteral",
                 "value": "Bob"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "StringLiteral",
                 "value": "Alice"
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "bar"
         }
     },
     {
         "_type": "Apply",
         "callee": {
             "_type": "Label",
             "of": "baz"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test9Curry2Ast(t *testing.T) {
	input := `
bar: (a:@str, b:@str, c:@str) {
    @printf("a: %s, b: %s, c: %s\n", a, b, c)
}
foo: (cb:(@str)){
    cb("c")
}
foo(bar("a", "b"))

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "bar",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "a: %s, b: %s, c: %s\n"
                     },
                     {
                         "_type": "Label",
                         "of": "a"
                     },
                     {
                         "_type": "Label",
                         "of": "b"
                     },
                     {
                         "_type": "Label",
                         "of": "c"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ],
         "params": [
             {
                 "_name": "a",
                 "_type": "Type",
                 "value": "@str"
             },
             {
                 "_name": "b",
                 "_type": "Type",
                 "value": "@str"
             },
             {
                 "_name": "c",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "c"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type",
                 "values": [
                     {
                         "_type": "Type",
                         "value": "@str"
                     }
                 ]
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "a"
                     },
                     {
                         "_type": "StringLiteral",
                         "value": "b"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "bar"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}

func Test9Curry3Ast(t *testing.T) {
	input := `
foo: (cb: ()){
    cb()
}
bar: (name: @str) {
    @printf("Hello, %s!\n", name)
}
foo(bar("John"))

`
	b, err := ToAst(strings.NewReader(input))
	require.NoError(t, err)
	actual := string(b)

	expected := `
[
     {
         "_name": "foo",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "callee": {
                     "_type": "Label",
                     "of": "cb"
                 }
             }
         ],
         "params": [
             {
                 "_name": "cb",
                 "_type": "Type"
             }
         ]
     },
     {
         "_name": "bar",
         "_type": "Function",
         "inner": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "Hello, %s!\n"
                     },
                     {
                         "_type": "Label",
                         "of": "name"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "isbuiltin": true,
                     "of": "@printf"
                 }
             }
         ],
         "params": [
             {
                 "_name": "name",
                 "_type": "Type",
                 "value": "@str"
             }
         ]
     },
     {
         "_type": "Apply",
         "arguments": [
             {
                 "_type": "Apply",
                 "arguments": [
                     {
                         "_type": "StringLiteral",
                         "value": "John"
                     }
                 ],
                 "callee": {
                     "_type": "Label",
                     "of": "bar"
                 }
             }
         ],
         "callee": {
             "_type": "Label",
             "of": "foo"
         }
     }
 ]
`
	require.JSONEq(t, expected, actual, fmt.Sprintf("got: %v", actual))
}
